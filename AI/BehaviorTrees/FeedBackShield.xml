<BehaviorTree>

  <!--
	=============================================================================================================================================
	SDK_Grunt_04.xml

	Behavior tree that builds on top of the SDK_Grunt_03.xml.
	Additions / changes:
		- will also make use of covers in its Combat behavior
		- picks its open-combat position via a TPS query instead of blindly moving towards the target
		- once having lost track of the player, it will slowly approach the player's last known position, play a search animation and then return to its initial position and idle
		- furthermore, this is the first BT that supports sharing a target among multiple AIs if they are in the same group (in the 01-03 SDK BTs, each AI only knew what it had perceived 
		  by itself, not what other AIs had perceived so far)
		- to have multiple AIs share the target information, each of them must have the same "groupid" assigned in the Sandbox and that groupid must not be 0 (0 would mean: the AI is 
		  in *no* group at all)
		- careful: when providing a groupid in the Sandbox, make sure you provide an integer number, not a floating point number (Sandbox/Lua accepts floats, but converts them to ints internally, so
		  e. g. 0.1 ends up as 0)
	=============================================================================================================================================
	-->

  <Variables>
    <Variable name="HasTarget"/>

    <!-- these variables are not used in this BT, but need to be present to prevent a warning caused by BasicAI:OnReset() -->
    <Variable name="ExecuteSequence" />
    <Variable name="ExecuteInterruptibleSequence" />
  </Variables>

  <SignalVariables>
    <Signal name="OnNewAttentionTarget" variable="HasTarget" value="true"/>
    <Signal name="OnNoTarget" variable="HasTarget" value="false"/>
  </SignalVariables>

  <Timestamps>
    <Timestamp name="TargetSpotted" setOnEvent="OnEnemySeen" exclusiveTo="TargetLost"/>
    <Timestamp name="TargetLost" setOnEvent="OnLostSightOfTarget" exlusiveTo="TargetSpotted"/>
    <Timestamp name="GroupTargetSpotted" setOnEvent="OnGroupTargetVisual" exclusiveTo="GroupTargetLost"/>
    <Timestamp name="GroupTargetLost" setOnEvent="OnGroupTargetMemory" exclusiveTo="GroupTargetSpotted"/>
  </Timestamps>

  <Root>

    <StateMachine>

      <!--
			=================================================
					Idle
			=================================================
			-->

      <State name="Idle">

        <Transitions>
          <Transition to="Defend" onEvent="OnNewAttentionTarget"/>
        </Transitions>

        <BehaviorTree>

          <Sequence>
            <Log message="Hie!!!!" />
            <SetAlertness value="0"/>

            <Stance name="Relaxed"/>

            <Move to="InitialPosition" speed="Walk" stance="Relaxed"/>

            <ExecuteLua code="entity.actor:HolsterItem(true)"/>

            <Animate name="ZZ_AI_idleBreak"/>

            <Halt/>

          </Sequence>

        </BehaviorTree>

      </State>

      <!--
			=================================================
					Defend
			=================================================
			-->
      
      <State name="Defend">

        <Transitions>
          <Transition to="Idle" onEvent="OnTargetDead" />
        </Transitions>

        <BehaviorTree>
          <Loop>
            <Sequence>
              <ExecuteLua code="entity:SelectPrimaryWeapon()" />
              <Log message="Attackkkkkk!!!!" />
              <!--<Shield />-->

            </Sequence>
          </Loop>

        </BehaviorTree>

      </State>
      
      <!--
			=================================================
					Move
			=================================================
			-->

      <State name="Move">
        <Transitions>
          <Transition to="Combat" onEvent="OnTargetEnteredMeleeRange" />
          <Transition to="Idle" onEvent="OnTargetDead" />
        </Transitions>

        <BehaviorTree>
          <Sequence>
            <Log message="Now I am fiht with you..." />
            <ExecuteLua code="entity:SelectPrimaryWeapon()" />
            <Communicate name="TargetSpottedWhileSearching" channel="Reaction" expirity="1.0" waitUntilFinished="0" />
            <Move speed="Walk" to="Target" bodyOrientation="FullyTowardsMovementDirection" stopWithinDistance="2.0" fireMode="Melee" strafe="true" avoidGroupMates="true" avoidDangers="true"/>
          </Sequence>
        </BehaviorTree>

      </State>

      <!--
			=================================================
					Combat
			=================================================
			-->

      <State name="Combat">

        <Transitions>
          <!--<Transition to="ApproachAndInspectLastKnownPlayerPosition" onEvent="GoTo_ApproachAndInspectLastKnownPlayerPosition"/>-->
          <Transition to="Move" onEvent="OnTargetLeftMeleeRange" />
          <Transition to="Idle" onEvent="OnTargetDead" />
        </Transitions>

        <BehaviorTree>
          <Sequence>
            <Log message="Combat time!!!!" />
            <Loop>
              <Selector>
                <GroupScope name="AttackScope" allowedConcurrentUsers="1">
                  <Sequence>
                    <Melee target="AttentionTarget" cylinderRadius="0.4" />
                    <Wait duration="2" />
                  </Sequence>
                </GroupScope>

                <Sequence>
                  <Log message="11111111111111111111111111111111111111111111111I am wait for attack" />
                  <Wait duration="0.4"/>
                </Sequence>

              </Selector>
            </Loop>
          </Sequence>
        </BehaviorTree>

      </State>

      <!--
			=================================================
					ApproachAndInspectLastKnownPlayerPosition
			=================================================
			-->

      <State name="ApproachAndInspectLastKnownPlayerPosition">

        <Transitions>
          <Transition to="Idle" onEvent="GoTo_Idle"/>
          <Transition to="Combat" onEvent="OnEnemySeen"/>
          <Transition to="Combat" onEvent="OnGroupTargetVisual"/>
          <Transition to="Combat" onEvent="GroupMemberEnteredCombat"/>
        </Transitions>

        <BehaviorTree>

          <Sequence>

            <SuppressFailure>

              <Move to="Target" speed="Walk" stance="Alerted" fireMode="Off" avoidDangers="0" stopWithinDistance="1"/>

            </SuppressFailure>

            <Parallel successMode="any">

              <Animate name="AI_SearchLookAround" loop="1"/>

              <SuppressFailure>
                <Timeout duration="10"/>
              </SuppressFailure>

            </Parallel>

            <SendTransitionSignal name="GoTo_Idle"/>

          </Sequence>

        </BehaviorTree>

      </State>

    </StateMachine>

  </Root>

</BehaviorTree>
